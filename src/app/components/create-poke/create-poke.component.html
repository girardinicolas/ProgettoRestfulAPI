<!-- Hero -->
<section class="hero">
  <h1>Scegli e Crea la Tua Poke</h1>
  <p>
    Ingredienti freschi, immagini sovrapposte in tempo reale. SÃ¬, anche la
    salsa.
  </p>
  <!-- Messaggio di errore -->
  @if (errorMessage()) {
  <div class="error-message">
    {{ errorMessage() }}
  </div>
  }
</section>

<div class="page">
  <!-- Anteprima ciotola -->
  <section class="preview card">
    <div class="preview-stage">
      <img class="layer bowl" [src]="bowlImg" alt="bowl" />
      @for (ing of selectedForRender(); track trackByFn($index, ing)) {
      <img
        class="layer"
        [class.protein-pos-0]="
          isProtein(ing) && getProteinPosition(ing.id) === 0
        "
        [class.protein-pos-1]="
          isProtein(ing) && getProteinPosition(ing.id) === 1
        "
        [class.protein-pos-2]="
          isProtein(ing) && getProteinPosition(ing.id) === 2
        "
        [class.protein-pos-3]="
          isProtein(ing) && getProteinPosition(ing.id) === 3
        "
        [class.condiment]="ing.kind === 'condiment'"
        [class.sauce]="ing.kind === 'sauce'"
        [src]="ing.img"
        [style.zIndex]="
          isProtein(ing) ? getProteinZIndex(getProteinPosition(ing.id)) : ing.z
        "
        [style.opacity]="ing.opacity ?? 1"
        [alt]="ing.name"
      />
      }
    </div>

    <div class="preview-actions">
      <button class="btn ghost" (click)="resetAll()">Reset</button>
      <button class="btn primary" (click)="toggleSummary()">
        {{ showSummary() ? "Nascondi riepilogo" : "Mostra riepilogo" }}
      </button>
      <button
        class="btn success"
        type="button"
        [disabled]="!canSavePoke() || saving()"
        (click)="savePoke()"
      >
        {{ saving() ? "Salvataggio..." : "Salva Poke" }}
      </button>
    </div>
    @if (apiFeedback(); as feedback) {
    <div
      class="api-message"
      [class.error]="feedback.type === 'error'"
      [class.success]="feedback.type === 'success'"
    >
      {{ feedback.text }}
    </div>
    } @if (showSummary()) {
    <div class="summary-panel">
      <h4>Riepilogo ingredienti</h4>
      <div class="summary-row">
        <strong>Base:</strong>
        <div class="summary-values">
          @if (getBaseIngredient(); as base) {
          <span class="chip">{{ base.name }}</span>
          } @else {
          <span class="empty">Nessuna base selezionata</span>
          }
        </div>
      </div>
      @for (group of getSummaryGroups(); track group.kind) {
      <div class="summary-row">
        <strong>{{ group.label }}:</strong>
        <div class="summary-values">
          @if (getSelectedIngredients(group.kind); as items) { @if
          (items.length) { @for (ing of items; track ing.id) {
          <span class="chip">{{ ing.name }}</span>
          } } @else {
          <span class="empty">
            {{
              hasNoneSelected(group.kind) ? getNoneLabel(group.kind) : "Nessuno"
            }}
          </span>
          } }
        </div>
      </div>
      }
    </div>
    }
  </section>

  <!-- Scelte -->
  <section class="selectors">
    <!-- Base -->
    <div class="group card">
      <h3>Base</h3>
      <div class="grid">
        @for (item of byKind('base'); track item.id) {
        <button
          type="button"
          class="option"
          [class.selected]="isSelected(item.id)"
          (click)="toggle(item.id)"
        >
          <img [src]="item.thumb || item.img" [alt]="item.name" />
          <span>{{ item.name }}</span>
        </button>
        }
      </div>
    </div>

    <!-- Proteine -->
    <div
      class="group card"
      [class.locked]="isCategoryLocked('protein')"
      [attr.data-locked]="isCategoryLocked('protein')"
    >
      <h3>
        Proteine
        <span class="count">({{ getSelectedCount("protein") }}/4)</span>
      </h3>
      @if (isCategoryLocked('protein')) {
      <p class="hint">Seleziona prima una base.</p>
      }
      <div class="grid">
        @for (item of byKind('protein'); track item.id) {
        <button
          type="button"
          class="option"
          [class.selected]="isSelected(item.id)"
          [class.disabled]="
            isCategoryLocked('protein') ||
            (!isSelected(item.id) && !canAddMore('protein'))
          "
          [disabled]="
            isCategoryLocked('protein') ||
            (!isSelected(item.id) && !canAddMore('protein'))
          "
          (click)="toggle(item.id)"
        >
          <img [src]="item.thumb || item.img" [alt]="item.name" />
          <span>{{ item.name }}</span>
        </button>
        }
      </div>
    </div>

    <!-- Condimenti -->
    <div
      class="group card"
      [class.locked]="isCategoryLocked('condiment')"
      [attr.data-locked]="isCategoryLocked('condiment')"
    >
      <h3>
        Condimenti
        <span class="count">({{ getSelectedCount("condiment") }}/3)</span>
      </h3>
      @if (isCategoryLocked('condiment')) {
      <p class="hint">Seleziona prima almeno una proteina.</p>
      }
      <div class="grid">
        @for (item of byKind('condiment'); track item.id) {
        <button
          type="button"
          class="option"
          [class.selected]="isSelected(item.id)"
          [class.disabled]="
            isCategoryLocked('condiment') ||
            (!isSelected(item.id) && !canAddMore('condiment'))
          "
          [disabled]="
            isCategoryLocked('condiment') ||
            (!isSelected(item.id) && !canAddMore('condiment'))
          "
          (click)="toggle(item.id)"
        >
          <img [src]="item.thumb || item.img" [alt]="item.name" />
          <span>{{ item.name }}</span>
        </button>
        }
      </div>
    </div>

    <!-- Salse -->
    <div
      class="group card"
      [class.locked]="isCategoryLocked('sauce')"
      [attr.data-locked]="isCategoryLocked('sauce')"
    >
      <h3>
        Salse <span class="count">({{ getSelectedCount("sauce") }}/2)</span>
      </h3>
      @if (isCategoryLocked('sauce')) {
      <p class="hint">Seleziona prima almeno un condimento.</p>
      }
      <div class="grid">
        @for (item of byKind('sauce'); track item.id) {
        <button
          type="button"
          class="option"
          [class.selected]="isSelected(item.id)"
          [class.disabled]="
            isCategoryLocked('sauce') ||
            (!isSelected(item.id) && !canAddMore('sauce'))
          "
          [disabled]="
            isCategoryLocked('sauce') ||
            (!isSelected(item.id) && !canAddMore('sauce'))
          "
          (click)="toggle(item.id)"
        >
          <img [src]="item.thumb || item.img" [alt]="item.name" />
          <span>{{ item.name }}</span>
        </button>
        }
      </div>
    </div>

    <!-- Topping -->
    <div
      class="group card"
      [class.locked]="isCategoryLocked('topping')"
      [attr.data-locked]="isCategoryLocked('topping')"
    >
      <h3>
        Topping <span class="count">({{ getSelectedCount("topping") }}/1)</span>
      </h3>
      @if (isCategoryLocked('topping')) {
      <p class="hint">Seleziona prima almeno una salsa.</p>
      }
      <div class="grid">
        @for (item of byKind('topping'); track item.id) {
        <button
          type="button"
          class="option"
          [class.selected]="isSelected(item.id)"
          [class.disabled]="
            isCategoryLocked('topping') ||
            (!isSelected(item.id) && !canAddMore('topping'))
          "
          [disabled]="
            isCategoryLocked('topping') ||
            (!isSelected(item.id) && !canAddMore('topping'))
          "
          (click)="toggle(item.id)"
        >
          <img [src]="item.thumb || item.img" [alt]="item.name" />
          <span>{{ item.name }}</span>
        </button>
        }
      </div>
    </div>
  </section>
</div>
